8-Layer Replit Prompt Template for Mundo Tango

You are building a secure, emotional, and role-aware feature for the Mundo Tango platform using Replit. Your goal is to implement and validate a memory-based, consent-driven system across 8 layers:

ğŸ” Use Supabase as your backend (auth, db, RLS). Use Replit as your frontend+agent workspace.

â¸»

ğŸ§© LAYER 1: Frontend Component
	â€¢	Build a component in React or Replit UI that allows a logged-in user to:
	â€¢	Select their current active role (e.g. dancer, DJ, organizer)
	â€¢	Request a custom role (with text + reason)
	â€¢	View their memory permissions, including emotional tag visibility

âœ… Output: UI code with hooks to Supabase auth + backend functions
âœ… Include: Role-switch dropdown, visibility status component, custom role request form

â¸»

âš™ï¸ LAYER 2: Backend Logic
	â€¢	Create /api/submit-custom-role-request
	â€¢	Accept user_id, requested_role, context, justification
	â€¢	Check if user has verified identity and is linked to Replit OAuth session
	â€¢	Insert request into custom_role_requests table

âœ… Output: Node/Express or Replit backend route
âœ… Include: input validation, session auth extraction

â¸»

ğŸ” LAYER 3: Authentication + OAuth Session Linking
	â€¢	Ensure user is authenticated via Replit OAuth
	â€¢	Cross-link replit_id to the correct Supabase user.id
	â€¢	If mismatch: update or error out
	â€¢	Middleware: auto-link OAuth â†’ Supabase ID on login

âœ… Output: Session verification middleware or function
âœ… Include: Logging replit_id, Supabase ID check/update

â¸»

ğŸ›¡ LAYER 4: RBAC + ABAC Enforcement
	â€¢	Define roles table with RBAC metadata:
	â€¢	Permissions, allowed memory types, emotional tag access
	â€¢	ABAC logic:
	â€¢	â€œOnly show memories where emotion_visibility = public OR user_id = current_user OR trust_level >= 2â€

âœ… Output: Supabase policies.sql + ABAC table logic
âœ… Optional: Use Oso or embed in Supabase RLS

â¸»

ğŸ§  LAYER 5: Consent & Memory Metadata Enforcement
	â€¢	On memory post/edit:
	â€¢	Ensure co-tagging requires mutual approval
	â€¢	Emotional tags require explicit visibility tier
	â€¢	On memory surfacing:
	â€¢	Filter by consent, role, emotional trust level

âœ… Output: Supabase memories + memory_tags tables with RLS
âœ… Include: visibility, consent_granted, trust_circle_level

â¸»

ğŸ“Š LAYER 6: Admin Interface (Role Requests + Debugging)
	â€¢	Build admin-only dashboard in Replit
	â€¢	View pending custom role requests
	â€¢	Approve/deny with comment
	â€¢	View policy debug logs: â€œWhy was this access blocked?â€

âœ… Output: UI dashboard code + Supabase read/write logic
âœ… Bonus: Replit-friendly prompt for reviewing flagged rejections

â¸»

ğŸ”„ LAYER 7: Logging, Trust Graphs & RLS Testing
	â€¢	Log every action:
	â€¢	Role requests
	â€¢	Consent changes
	â€¢	Memory view attempts (allowed or blocked)
	â€¢	Test Supabase RLS with actual queries to confirm access is enforced properly

âœ… Output: Insert logs to audit_logs table
âœ… Include: action_type, user_id, memory_id, result

â¸»

ğŸ¯ LAYER 8: Developer Handoff & Traceable Memory Behavior
	â€¢	Document everything in replit.md:
	â€¢	How roles are linked
	â€¢	How RLS is structured
	â€¢	How to test memory access per role + trust level
	â€¢	Include: screenshots of working role requests, error cases, debug logs

âœ… Output: Clear Replit markdown doc + reproducible steps
âœ… Bonus: Include curl or fetch test snippets

â¸»

ğŸ’¡ EXAMPLE FLOW:

	â€¢	User logs in with Replit
	â€¢	replit_id is updated/linked in Supabase
	â€¢	User requests a custom role (â€œDJ + visual artistâ€)
	â€¢	Admin sees request in Replit UI â†’ approves
	â€¢	User now gains access to tag music AND media memories
	â€¢	RLS prevents viewing â€œprivateâ€ memories without consent
	â€¢	Logs show all actions, roles, and surfacing rules applied

â¸»
