ğŸ“Œ OBJECTIVE:
Fix the Groups system end-to-end using the 11 Layer system. Ensure:
- Users are auto-added to their primary city group
- The UI reflects accurate group status (joined, pending, etc.)
- Clicking a group opens a **Group Detail Page** based on TT files

---

1ï¸âƒ£ EXPERTISE LAYER
â†’ You are acting as a full-stack developer (React + Supabase + Tailwind), with deep UX fidelity to the Mundo Tango design system and TT reference files.

---

2ï¸âƒ£ OPEN SOURCE SCAN LAYER
â†’ Before building, check:
- [react-query](https://tanstack.com/query/latest) or SWR for real-time state
- [supabase-js](https://supabase.com/docs/reference/javascript)
- [Headless UI](https://headlessui.dev/) for tabs and toggles

---

3ï¸âƒ£ LEGAL & COMPLIANCE LAYER
â†’ No PII shared. Group visibility must respect:
- Public groups: visible to all
- Private groups: request-based only
- Default visibility = Public unless explicitly marked

---

4ï¸âƒ£ CONSENT & UX SAFEGUARDS LAYER
â†’ Auto-join **only** if group is public and matches user.city_dance_primary  
â†’ For private groups, always show "Request to Join"

---

5ï¸âƒ£ DATA LAYER
ğŸ“Œ Tables:
- `groups`: id, name, slug, description, visibility (public/private), created_by
- `group_members`: id, group_id, user_id, role, status ("member", "pending", "denied")

ğŸ¯ Add relationship indexes between users.city_dance_primary â†” groups.slug

---

6ï¸âƒ£ BACKEND LAYER
âœ… Add API Endpoints:
- `POST /api/groups/:slug/join`
- `POST /api/groups/:slug/request`
- `GET /api/groups/:slug/details`

ğŸ¯ On login or registration:
- Check if group exists for `user.city_dance_primary`
- If yes, and group is public, auto-add user to `group_members`

---

7ï¸âƒ£ FRONTEND LAYER
âœ… On the Groups list page:
- Hide "Join Group" if already joined
- Clicking the group card opens **Group Detail Page**

ğŸ“„ GroupDetailPage.tsx:
- Pull full design from TT files
- Show banner, description, member list, events, shared posts
- Add tabs: Overview | Events | Members | Memories

ğŸ“Œ Use: `pages/groups/[slug].tsx`

---

8ï¸âƒ£ SYNC & AUTOMATION LAYER
â†’ After user joins, broadcast membership via Supabase Realtime
â†’ Optionally trigger welcome automation (e.g., post to group's feed)
â†’ Consider N8N job to reprocess past users missing group joins

---

9ï¸âƒ£ SECURITY & PERMISSIONS LAYER
â†’ Enforce RBAC on:
- Who can join/create groups
- Who sees member info
â†’ For private groups, only allow invites or approvals

---

ğŸ”Ÿ AI & REASONING LAYER
â†’ When joining a group:
- Update user embeddings / interest vectors
- AI can suggest content/memories based on group activity

---

1ï¸âƒ£1ï¸âƒ£ TESTING & OBSERVABILITY LAYER
âœ… Tests:
- You (admin@mundotango.life) are placed in â€œBuenos Aires Tangoâ€
- Buttons respond appropriately
- GroupDetailPage loads without error

ğŸ“Š Add console logs, dev mode feedback, and Supabase audit entry: `group_joined`

---

ğŸ“ OUTPUT SUMMARY:
- âœ… Auto-join to city group at login
- âœ… Fixed Join/Request button logic
- âœ… Clicking group loads TT-inspired detail page
- âœ… Fully conforms to 11L architecture