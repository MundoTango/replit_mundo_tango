const RestModel = require("./RestModel");
const _ = require("lodash")
const { v4: uuidv4 } = require('uuid');
const { Op, sequelize, Sequelize } = require("../Database");

class ChatRoomUser extends RestModel {
    constructor() {
        super("chat_room_users")
    }

    softdelete() {
        return true;
    }

    /**
     * The attributes that are mass assignable.
     *
     * @var array
     */

    getFields() {
        return [
            'chat_room_slug', "target_user_slug", 'is_owner', 'is_subAdmin', 'status', 'unread_message_count'
        ];
    }


    showColumns() {
        return [
            'id', 'slug', 'user_slug', 'chat_room_slug', 'is_owner', 'is_subAdmin',
            'is_kicked', 'is_leaved', 'status', 'unread_message_count'
        ];
    }

    /**
     * omit fields from update request
     */
    exceptUpdateField() {
        return [];
    }

    async createRecord(request, params) {
        let record = [];

        console.log(params);
        if (params?.is_newRoom) {
            let sender_record = {
                slug: uuidv4(),
                chat_room_slug: params.slug,
                user_slug: request.user.slug,
                is_owner: true,
                status: CHAT_ROOM_STATUS_ENUM.ACCEPTED,
                unread_message_count: 0,
                last_message_timestamp: new Date()
            }
            let reciever_record = {
                slug: uuidv4(),
                chat_room_slug: params.slug,
                user_slug: request.body.target_user_slug,
                is_owner: false,
                status: CHAT_ROOM_STATUS_ENUM.PENDING,
                unread_message_count: 0,
                last_message_timestamp: new Date()
            }
            record.push(sender_record)
            record.push(reciever_record)
        }
        else if (params?.is_newGroup) {
            let owner_record = {
                slug: uuidv4(),
                chat_room_slug: params.slug,
                user_slug: request.user.slug,
                is_owner: true,
                status: CHAT_ROOM_STATUS_ENUM.ACCEPTED,
                unread_message_count: 0,
                last_message_timestamp: new Date()
            }
            record.push(owner_record)

            const members = params?.members || [];
            for (let i = 0; i < members.length; i++) {
                const member_slug = members[i];
                let member_record = {
                    slug: uuidv4(),
                    chat_room_slug: params.slug,
                    user_slug: member_slug,
                    is_owner: false,
                    status: CHAT_ROOM_STATUS_ENUM.PENDING,
                    unread_message_count: 0,
                    last_message_timestamp: new Date()
                }
                record.push(member_record)
            }
        }
        else if (params.is_newMembers) {
            let participant_record = {
                slug: uuidv4(),
                chat_room_slug: params.chat_room_slug,
                user_slug: params.user_slug,
                is_owner: false,
                status: CHAT_ROOM_STATUS_ENUM.PENDING,
                unread_message_count: 0,
                last_message_timestamp: new Date()
            }
            record.push(participant_record)
        }

        if (!_.isEmpty(record)) {
            const result = await this.orm.bulkCreate(record);
            return result.map(item => item.toJSON())
        }
        else {
            return []
        }
    }


    // async getChatThreads(user_slug) {
    //     const record = await this.orm.findAll({
    //         where: {
    //             user_slug: user_slug,
    //             is_visible: true,
    //             deletedAt: null
    //         },
    //         include: [
    //             {
    //                 model: this.getModel(),
    //                 required: false,
    //                 as: 'ChatRoomUser_ChatRoomSlug_Self_Single',
    //                 where: {
    //                     user_slug: { [Op.ne]: user_slug }
    //                 },
    //                 include: {
    //                     model: ChatRoom.instance().getModel(),
    //                     required: true,
    //                     as: "ChatRoomUser_ChatRoomSlug",
    //                     where: {
    //                         type: CHAT_ROOM_TYPE_ENUM.SINGLE
    //                     }
    //                 }
    //             },
    //             {
    //                 model: ChatRoom.instance().getModel(),
    //                 required: true,
    //                 as: "ChatRoomUser_ChatRoomSlug",
    //                 where: {
    //                     deletedAt: null
    //                 },
    //                 include: {
    //                     model: ChatMessages.instance().getModel(),
    //                     required: false,
    //                     as: "ChatMessage_ChatRoomSlug_Single",
    //                     where: {
    //                         deletedAt: null
    //                     },
    //                     include: {
    //                         model: ChatMessageStatus.instance().getModel(),
    //                         required: true,
    //                         as: "ChatMessageStatus_ChatMessageSlug_Single",
    //                         where: {
    //                             user_slug: user_slug,
    //                             deletedAt: null
    //                         },
    //                     },
    //                 },
    //             }
    //         ],
    //         order: [
    //             ['last_message_timestamp', 'DESC'],
    //             [
    //                 {
    //                     model: ChatRoom.instance().getModel(),
    //                     as: 'ChatRoomUser_ChatRoomSlug',
    //                 },
    //                 {
    //                     model: ChatMessages.instance().getModel(),
    //                     as: 'ChatMessage_ChatRoomSlug_Single'
    //                 },
    //                 'createdAt',
    //                 'DESC'
    //             ]
    //         ]
    //     })

    //     return record.map(item => item.toJSON())
    // }

    async getGroupThreads(user_slug) {
        const record = await this.orm.findAll({
            where: {
                user_slug: user_slug,
                is_visible: true,
                deletedAt: null
            },
            include: [
                {
                    model: this.getModel(),
                    required: true,
                    as: 'ChatRoomUser_ChatRoomSlug_Self',
                    include: {
                        model: User.instance().getModel(),
                        required: true,
                        as: "ChatRoomUser_UserSlug",
                    },
                    where: {
                        [Op.or]: [
                            { user_slug: user_slug },
                            {
                                [Op.and]: [
                                    { user_slug: { [Op.ne]: user_slug } },
                                    { is_leaved: false, },
                                    { is_kicked: false }
                                ]
                            }

                        ]
                    }
                },
                {
                    model: ChatRoom.instance().getModel(),
                    required: true,
                    as: "ChatRoomUser_ChatRoomSlug",
                    where: {
                        type: CHAT_ROOM_TYPE_ENUM.GROUP,
                        deletedAt: null
                    },
                }
            ],
            order: [
                ['last_message_timestamp', 'DESC'],
            ]
        })

        return record.map(item => item.toJSON())
    }

    async getChatThreads(user_slug) {
        const record = await this.orm.findAll({
            where: {
                user_slug: user_slug,
                is_visible: true,
                deletedAt: null
            },
            include: [
                {
                    model: this.getModel(),
                    required: true,
                    as: 'ChatRoomUser_ChatRoomSlug_Self_Single',
                    where: {
                        user_slug: { [Op.ne]: user_slug }
                    },
                    include: {
                        model: User.instance().getModel(),
                        required: true,
                        as: "ChatRoomUser_UserSlug",
                    }
                },
                {
                    model: ChatRoom.instance().getModel(),
                    required: true,
                    as: "ChatRoomUser_ChatRoomSlug",
                    where: {
                        type: CHAT_ROOM_TYPE_ENUM.SINGLE,
                        deletedAt: null
                    },
                    include: {
                        model: ChatMessages.instance().getModel(),
                        required: false,
                        as: "ChatMessage_ChatRoomSlug",
                        where: {
                            deletedAt: null
                        },
                        include: {
                            model: ChatMessageStatus.instance().getModel(),
                            required: true,
                            as: "ChatMessageStatus_ChatMessageSlug_Single",
                            where: {
                                user_slug: user_slug,
                                deletedAt: null
                            },
                        },
                        limit: 1,
                        separate: true,
                        order: [['createdAt', 'DESC']]
                    },
                }
            ],
            order: [
                ['last_message_timestamp', 'DESC'],
                // [
                //     {
                //         model: ChatRoom.instance().getModel(),
                //         as: 'ChatRoomUser_ChatRoomSlug',
                //     },
                //     {
                //         model: ChatMessages.instance().getModel(),
                //         as: 'ChatMessage_ChatRoomSlug'
                //     },
                //     'createdAt',
                //     'DESC'
                // ]
            ]
        })

        return record.map(item => item.toJSON())
    }


    async getRoomMembersWithDetails(chat_room_slug) {
        const record = await this.orm.findAll({
            where: {
                chat_room_slug: chat_room_slug,
                is_leaved: false,
                is_kicked: false,
                deletedAt: null
            },
            include: {
                model: User.instance().getModel(),
                as: "ChatRoomUser_UserSlug",
                required: true,
                where: {
                    deletedAt: null
                }
            }
        })

        return record.map(item => item.toJSON())
    }

    async findRoomAgainstUsers(user_slug, target_user_slug) {
        const record = await this.orm.findOne({
            where: {
                chat_room_slug: {
                    [Op.in]: [Sequelize.literal(`select cru2.chat_room_slug from chat_room_users as cru2
                     where cru2.user_slug = '${user_slug}' and cru2.deletedAt is null`)]
                },
                user_slug: target_user_slug,
            },
            include: {
                model: ChatRoom.instance().getModel(),
                as: "ChatRoomUser_ChatRoomSlug",
                required: true,
                where: {
                    type: CHAT_ROOM_TYPE_ENUM.SINGLE,
                    deletedAt: null,
                }
            }
        })

        return _.isEmpty(record) ? {} : record.toJSON();
    }


    async getRoomUsers(chat_room_slug) {
        const record = await this.orm.findAll({
            where: {
                chat_room_slug: chat_room_slug,
                is_leaved: false,
                is_blocked: false,
                is_kicked: false,
                deletedAt: null,
            },
            raw: true,
        })

        return _.isEmpty(record) ? [] : record

    }

    async updateLeavedMember(chat_room_slug = '', user_slug = '') {
        await this.orm.update(
            { is_owner: false, is_subAdmin: false, is_leaved: false, is_kicked: false, deletedAt: null },
            {
                where: {
                    chat_room_slug: chat_room_slug,
                    user_slug: user_slug
                }
            })
        return true;
    }

    async removeMemberFromChatRoom(chat_room_slug = '', user_slug = '') {
        await this.orm.update(
            { is_kicked: true },
            {
                where: {
                    chat_room_slug: chat_room_slug,
                    user_slug: user_slug
                }
            })
        return true;
    }

    async incrementMessageCount(request, chat_room_slug) {

        const record = await this.orm.update(
            {
                unread_message_count: sequelize.literal('unread_message_count + 1'),
                last_message_timestamp: new Date()
            },
            {
                where: {
                    chat_room_slug,
                    [Op.not]: {
                        user_slug: request.user.slug,
                    },
                    is_blocked: false,
                    deletedAt: null,
                }
            }
        );

        return true;

    }

    async updateLastMessageTimeStamp(chat_room_slug) {
        const record = await this.orm.update(
            { last_message_timestamp: new Date() },
            {
                where: {
                    chat_room_slug: chat_room_slug,
                    deletedAt: null,
                }
            }
        );
        return true;
    }

    async blockChatThread(request, chat_room_slug) {

        const record = await this.orm.update(
            { is_blocked: true },
            {
                where: {
                    chat_room_slug,
                    user_slug: request.user.slug
                }
            }
        );

        return true;
    }

    async leaveChatRoom(user_slug, chat_room_slug) {

        const record = await this.orm.update(
            { is_leaved: true },
            {
                where: {
                    chat_room_slug,
                    user_slug: user_slug
                }
            }
        );

        return true;
    }

    async makeAdmin(user_slug, chat_room_slug) {
        await this.orm.update(
            { is_subAdmin: true },
            {
                where: {
                    chat_room_slug: chat_room_slug,
                    user_slug: user_slug
                }
            })
        return true;
    }

    async deleteChatThread(request, chat_room_slug) {
        const user_slug = request.user.slug;

        const record = await this.orm.update(
            { is_visible: false },
            {
                where: {
                    chat_room_slug,
                    user_slug
                }
            }
        );

        await ChatMessageStatus.instance().deleteThreadMessages(user_slug, chat_room_slug);

        return true;

    }

    async getUserRooms(user_slug) {
        const record = await this.orm.findAll({
            where: {
                user_slug,
                is_leaved: false,
                is_kicked: false,
                is_blocked: false,
                deletedAt: null,
            },
            raw: true,
        })
        return _.isEmpty(record) ? [] : record
    }

    async getRecordByUserAndRoom(user_slug, chat_room_slug) {
        const record = await this.orm.findOne({
            where: {
                user_slug: user_slug,
                chat_room_slug: chat_room_slug,
                is_leaved: false,
                is_kicked: false,
                deletedAt: null,
            },
            order: [['createdAt', 'desc']],
            raw: true,
        })

        return _.isEmpty(record) ? {} : record
    }

    async updateVisibility(user_slug, chat_room_slug) {
        await this.orm.update(
            { is_visible: true },
            {
                where: {
                    chat_room_slug,
                    // [Op.not]: { user_slug: user_slug }
                }
            }
        );
    }

    async resetMessageCount(chat_room_slug, user_slug) {
        await this.orm.update(
            { unread_message_count: 0 },
            {
                where: {
                    user_slug,
                    chat_room_slug
                }
            }
        );
        return true;

    }

    //this update specific user last message timestamp and increase message count
    async updateUserChatRoomLastMessageTimeStamp(chat_room_slug, user_slug) {
        const record = await this.orm.update(
            {
                last_message_timestamp: new Date(),
                unread_message_count: sequelize.literal('unread_message_count + 1')
            },
            {
                where: {
                    chat_room_slug: chat_room_slug,
                    user_slug: user_slug,
                    deletedAt: null,
                }
            }
        );
        return true;
    }

}

module.exports = ChatRoomUser

const ChatRoom = require("./ChatRoom");
const ChatMessageStatus = require("./ChatMessageStatus");
const { ARRAY } = require("sequelize");
const { CHAT_ROOM_STATUS_ENUM, CHAT_ROOM_TYPE_ENUM } = require("../config/enum");
const ChatMessages = require("./ChatMessages");
const User = require("./User");

