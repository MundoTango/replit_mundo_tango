ğŸ¯ OBJECTIVE:
Scott Boddye (admin@mundotango.life) is assigned to Buenos Aires but doesnâ€™t see any city groups in the â€œJoinedâ€ tab. Fix group visibility and auto-join detection. Then add:
â€¢ â€œFollow Groupâ€ (non-member view)
â€¢ RBAC/ABAC-based access controls
â€¢ Role-aware UI (locals vs visitors)
â€¢ All styling must match TT design system.

â€”

ğŸ§  1. EXPERTISE LAYER:
Youâ€™re a full-stack engineer using React + Supabase + RBAC/ABAC. Design with Moments UI system (indigo-coral theme, tabbed pages, mobile responsive).

â€”

ğŸ” 2. OPEN SOURCE SCAN LAYER:
Use/extend:
- `@casl/react` (already implemented)
- Supabase RLS
- Casbin if needed for ABAC
- Reuse `group_members` + new `group_followers` table

â€”

âš–ï¸ 3. LEGAL & COMPLIANCE LAYER:
- â€œFollowâ€ = view-only
- â€œJoinâ€ = full membership with data visibility
- Visitors canâ€™t post or see member lists unless invited

â€”

ğŸ”’ 4. CONSENT & UX SAFEGUARDS LAYER:
- â€œFollowâ€ creates a record but does not show user publicly
- UI must reflect clear states: Followed / Requested / Joined

â€”

ğŸ§© 5. DATA LAYER:
Add:
- `group_followers` (user_id, group_id, followed_at)
Fix:
- `group_members` edge-case: users auto-joined but not listed

â€”

âš™ï¸ 6. BACKEND LAYER:
- Fix `/api/user/auto-join-city-groups` logic (ensure city is set and used)
- Add `/api/groups/follow` and `/api/groups/unfollow` endpoints
- Update groups query to return `joined` and `followed` status

â€”

ğŸ–¥ 7. FRONTEND LAYER:
- On city match: auto join
- If user not local: show â€œFollow Groupâ€ CTA
- Joined tab shows real-time data
- Group card shows badge: â€œFollowingâ€ / â€œJoinedâ€ / â€œPendingâ€

â€”

ğŸ” 8. SYNC & AUTOMATION LAYER:
- Trigger auto-join once user auth + profile load
- Call follow/unfollow endpoints without reload

â€”

ğŸ›¡ 9. SECURITY & PERMISSIONS LAYER:
- Supabase RLS for `group_members` and `group_followers`
  - Locals: full group view
  - Visitors: limited tabs (Overview only)
- UI tabs conditionally rendered based on permission

â€”

ğŸ§  10. AI & REASONING LAYER:
- Group suggestion logic should prioritize:
  - Location proximity
  - Followed/shared group overlap
  - Tag similarity

(Leave stub logic for now â€” future implementation)

â€”

âœ… 11. TESTING & OBSERVABILITY LAYER:
- Add unit test: follow logic (user A canâ€™t follow private group)
- Add integration test: Scott auto-joins Buenos Aires
- Log RLS violations and auth issues for debugging

â€”

ğŸ“„ FILES TO UPDATE:
- `client/src/pages/groups.tsx`
- `client/src/pages/GroupDetailPage.tsx`
- `client/components/GroupCard.tsx`
- `server/routes.ts`
- `server/storage.ts`
- Supabase SQL schema: create `group_followers` table